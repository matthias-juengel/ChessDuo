require 'json'
default_platform(:ios)

platform :ios do
  desc "Upload ONLY metadata and promotional text (no build, no screenshots)"
  lane :metadata do
    api_key = app_store_connect_api_key(
      key_id: "3GB6K78M56",
      issuer_id: "69a6de81-d2b1-47e3-e053-5b8c7c11a4d1",
      key_filepath: "AuthKey_3GB6K78M56.p8",
      in_house: false
    )
    precheck(
      include_in_app_purchases: false,
      app_identifier: "app.chefs.my-chess-board",
      default_rule_level: :warn,
    )
    deliver(
      api_key: api_key,
      app_identifier: "app.chefs.my-chess-board",
      app_version: "1.0",
      app_review_information: JSON.parse(File.read("metadata/review_information.json"), symbolize_names: true),
      # Upload both metadata and screenshots from metadata
      skip_metadata: false,
      skip_screenshots: false,
      overwrite_screenshots: true,
      skip_binary_upload: true,
      submit_for_review: false,
      force: true,
      run_precheck_before_submit: false,
    )
  end

  desc "Generate placeholder screenshots from icon.png and upload them"
  lane :screenshots_placeholders do |options|
    # Generate placeholders into fastlane/screenshots/<locale>
    sh("../scripts/generate_app_store_images.sh #{options[:icon] || '../icon.png'} #{options[:with_title] ? '--with-title' : ''}")

    api_key = app_store_connect_api_key(
      key_id: "3GB6K78M56",
      issuer_id: "69a6de81-d2b1-47e3-e053-5b8c7c11a4d1",
      key_filepath: "AuthKey_3GB6K78M56.p8",
      in_house: false
    )

    deliver(
      api_key: api_key,
      app_identifier: "app.chefs.my-chess-board",
      app_version: "1.0",
      # Only upload screenshots (leave metadata/build alone)
      skip_metadata: true,
      skip_binary_upload: true,
      skip_screenshots: false,
      overwrite_screenshots: true,
      run_precheck_before_submit: false,
      force: true,
    )
  end

  desc "Build & upload to TestFlight external group"
  lane :beta do |options|
    # --- Auth (reuse App Store Connect API key) ---
    api_key = app_store_connect_api_key(
      key_id: "3GB6K78M56",
      issuer_id: "69a6de81-d2b1-47e3-e053-5b8c7c11a4d1",
      key_filepath: "AuthKey_3GB6K78M56.p8",
      in_house: false
    )

    # --- Bump build number & prepare changelog ---
    xcodeproj_path = Dir["*.xcodeproj"].first || "ChessDuo.xcodeproj"

    # Find the most recent previous build-bump commit (before we create a new one)
    prev_bump = sh("git log -n 1 --grep='^ci: bump build to ' --pretty=format:%H || true").strip

    # Read current build, bump, then commit the change
    current_build = get_build_number(xcodeproj: xcodeproj_path)
    increment_build_number(xcodeproj: xcodeproj_path)
    new_build = get_build_number(xcodeproj: xcodeproj_path)

    commit_version_bump(
      xcodeproj: xcodeproj_path,
      message: "ci: bump build to #{new_build}"
    )

    # Build changelog from commit subjects since the previous bump (exclude bump commits)
    range = prev_bump.empty? ? "" : "#{prev_bump}..HEAD"
    computed_changelog = sh(
      "git log #{range} --pretty=format:'- %s' --no-merges --grep='^ci: bump build to ' --invert-grep --grep='^Refactor' --invert-grep --grep='^refactor' --invert-grep --grep='^intern:' --invert-grep || true"
    ).strip
    computed_changelog = "Bug fixes and improvements" if computed_changelog.empty?

    # --- Build (gym) ---
    scheme_name = (options[:scheme] || "ChessDuo")
    build_ios_app(
      scheme: scheme_name,
      clean: true,
      export_method: "app-store"
    )

    # --- Upload to TestFlight & distribute to external group ---
    pilot(
      api_key: api_key,
      app_identifier: "app.chefs.my-chess-board",
      distribute_external: true,
      groups: [ (options[:group] || "Public Beta") ],
      notify_external_testers: true,
      wait_for_uploaded_build: true,
      changelog: (options[:changelog] || computed_changelog),
      beta_app_description: "Simple two-player offline chessboard.",
      beta_app_feedback_email: "itunes@matthias-juengel.de",
      beta_app_review_info: {
        contact_email: "itunes@matthias-juengel.de",
        contact_first_name: "Matthias",
        contact_last_name: "Juengel",
        contact_phone: "+491795270558",
        demo_account_name: "",
        demo_account_password: "",
        notes: "Offline two-player chess. No sign-in, no ads."
      }
    )
  end
end
